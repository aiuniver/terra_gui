{% extends 'project/base.html' %}

{% load static core_utils %}

{% block css_block %}
<link rel="stylesheet" href="{% static 'css/project/training.css' %}"/>
{% endblock css_block %}

{% block js_block %}
<script type="text/javascript" src="{% static 'js/project/plotly-latest.min.js' %}"></script>
<script type="text/javascript" src="{% static 'js/project/training.js' %}"></script>
{% endblock js_block %}

{% block content_block %}

<div class="toolbar project-training-toolbar">
    <div class="wrapper">
        <ul class="menu-section">
            <li data-type="charts" disabled="disabled">
                <span title="Графики"><img src="{% static 'imgs/training-charts.svg' %}" alt="" /></span>
            </li>
            <li data-type="scatters" disabled="disabled">
                <span title="Скаттеры"><img src="{% static 'imgs/training-scatters.svg' %}" alt="" /></span>
            </li>
            <li data-type="images" disabled="disabled">
                <span title="Изображения"><img src="{% static 'imgs/training-images.svg' %}" alt="" /></span>
            </li>
            <li data-type="texts" disabled="disabled">
                <span title="Текст"><img src="{% static 'imgs/training-texts.svg' %}" alt="" /></span>
            </li>
        </ul>
    </div>
</div>

<div class="board">
    <div class="graphics">
        <div class="wrapper">
            <div class="tabs-content">
                <div class="inner">
                    <div class="tabs-item graphics custom-scrollbar-wrapper">
                        <div class="tab-container">
                            <div class="charts hidden">
                                <div class="category-title">Графики</div>
                                <div class="content">
                                    <div class="inner"></div>
                                </div>
                            </div>
                            <div class="scatters hidden">
                                <div class="category-title">Скаттеры</div>
                                <div class="content">
                                    <div class="inner"></div>
                                </div>
                            </div>
                            <div class="images hidden">
                                <div class="category-title">Изображения</div>
                                <div class="content"></div>
                            </div>
                            <div class="texts hidden">
                                <div class="category-title">Текст</div>
                                <div class="content">
                                    <div class="inner"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="properties project-training-properties">
    <div class="wrapper">
        <div class="params">
            <form class="params-container" novalidate="novalidate" autocomplete="off">
                <div class="params-item params-config">
                    <div class="inner settings custom-scrollbar-wrapper">
                        <div class="params-item params-optimizer">
                            <div class="inner">
                                <div class="field-form field-inline">
                                    <label for="field_form-optimizer">Оптимизатор</label>
                                    <select id="field_form-optimizer" name="optimizer[name]" class="jquery-ui-menuselect">
                                        {% for name in request.terra_project.optimizers %}
                                            <option value="{{ name }}"{% if name == request.terra_project.training.optimizer.name %} selected="selected"{% endif %}>{{ name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="field-form form-inline-label">
                                    <div class="field-form field-inline">
                                        <label for="field_form-batch_sizes">Размер батча</label>
                                        <input name="batch_sizes" id="field_form-batch_sizes" type="number" value="{{ request.terra_project.training.batch_sizes }}" />
                                    </div>
                                    <div class="field-form field-inline">
                                        <label for="field_form-epochs_count">Количество эпох</label>
                                        <input name="epochs_count" id="field_form-epochs_count" type="number" value="{{ request.terra_project.training.epochs_count }}" />
                                    </div>
                                    <div class="field-form field-inline">
                                        <label for="field_form-learning_rate">Learning rate</label>
                                        <input name="optimizer[params][main][learning_rate]" id="field_form-learning_rate" type="number" value="" />
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="params-item params-optimizer-extra collapsable collapsed hidden">
                            <div class="params-title">Параметры оптимизатора</div>
                            <div class="inner form-inline-label"></div>
                        </div>

                        <div class="params-item params-output collapsable">
                            <div class="params-title">Параметры outputs слоев</div>
                            {% for layer in request.terra_project.layers.values %}
                                {% if layer.config.location_type == "output" %}
                                    <div class="inner">
                                        <div class="title">Слой <b>«{{ layer.config.name }}»</b></div>
                                        <div class="form-inline-label">
                                            <div class="field-form field-inline field-reverse">
                                                <label for="field_form-output-{{ layer.config.dts_layer_name }}-loss">Loss</label>
                                                <input type="hidden" name="outputs[{{ layer.config.dts_layer_name }}][task]" data-output="{{ layer.config.dts_layer_name }}" class="field_form-output_task field_form-{{ layer.config.dts_layer_name }}-output_task" />
                                                <select id="field_form-output-{{ layer.config.dts_layer_name }}-loss" name="outputs[{{ layer.config.dts_layer_name }}][loss]" data-output="{{ layer.config.dts_layer_name }}" class="jquery-ui-menuselect field_form-output_loss field_form-{{ layer.config.dts_layer_name }}-output_loss">
                                                    {% for task, items in request.terra_project.compile.items %}
                                                        <optgroup label="{{ task }}">
                                                            {% for loss in items.losses %}
                                                                <option value="{{ loss }}"{% task_loss_selected layer.config.dts_layer_name task loss %}>{{ loss }}</option>
                                                            {% endfor %}
                                                        </optgroup>
                                                    {% endfor %}
                                                </select>
                                            </div>
                                            <div class="field-form field-inline field-reverse">
                                                <label for="output-{{ layer.config.dts_layer_name }}-metrics">Метрика</label>
                                                <select id="output-{{ layer.config.dts_layer_name }}-metrics" name="outputs[{{ layer.config.dts_layer_name }}][metrics][]" data-output="{{ layer.config.dts_layer_name }}" class="jquery-ui-menuselect field_form-output_metrics field_form-{{ layer.config.dts_layer_name }}-output_metrics" disabled="disabled"></select>
                                            </div>
                                            <div class="field-form field-inline field-reverse">
                                                <label for="output-{{ layer.config.dts_layer_name }}-num_classes">Количество классов</label>
                                                <input id="output-{{ layer.config.dts_layer_name }}-num_classes" name="outputs[{{ layer.config.dts_layer_name }}][num_classes]" data-output="{{ layer.config.dts_layer_name }}" class="field_form-output_num_classes field_form-{{ layer.config.dts_layer_name }}-output_num_classes" type="number" value="{{ layer.config.num_classes }}" disabled="disabled" />
                                            </div>
                                        </div>
                                    </div>
                                {% endif %}
                            {% endfor %}
                        </div>

                        <div class="params-item params-checkpoint collapsable">
                            <div class="params-title">Чекпоинты</div>
                            <div class="inner form-inline-label">
                                <div class="field-form field-inline field-reverse">
                                    <label for="checkpoint[monitor][output]">Монитор</label>
                                    <select name="checkpoint[monitor][output]" id="checkpoint[monitor][output]" class="jquery-ui-menuselect">
                                        {% for layer in request.terra_project.layers.values %}
                                            {% if layer.config.location_type == "output" %}
                                                <option value="{{ layer.config.dts_layer_name }}"{% if request.terra_project.training.checkpoint.monitor.output == layer.config.dts_layer_name %} selected="selected"{% endif %}>Слой «{{ layer.config.name }}»</option>
                                            {% endif %}
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="field-form field-inline field-reverse">
                                    <label for="checkpoint[indicator]">Indicator</label>
                                    <select name="checkpoint[indicator]" id="checkpoint[indicator]" class="jquery-ui-menuselect">
                                        <option value="train"{% if request.terra_project.training.checkpoint.indicator.value == 'train' %} selected="selected"{% endif %}>train</option>
                                        <option value="val"{% if request.terra_project.training.checkpoint.indicator.value == 'val' %} selected="selected"{% endif %}>val</option>
                                    </select>
                                </div>
                                <div class="field-form field-inline field-reverse">
                                    <label for="checkpoint[monitor][out_type]">Тип</label>
                                    <select name="checkpoint[monitor][out_type]" id="checkpoint[monitor][out_type]" class="jquery-ui-menuselect">
                                        <option value="metrics"{% if request.terra_project.training.checkpoint.monitor.out_type == 'metrics' %} selected="selected"{% endif %}>Метрика</option>
                                        <option value="loss"{% if request.terra_project.training.checkpoint.monitor.out_type == 'loss' %} selected="selected"{% endif %}>Loss</option>
                                    </select>
                                </div>
                                <div class="field-form field-inline field-reverse">
                                    <label for="checkpoint[mode]">Режим</label>
                                    <select name="checkpoint[mode]" id="checkpoint[mode]" class="jquery-ui-menuselect">
                                        <option value="min"{% if request.terra_project.training.checkpoint.mode.value == 'min' %} selected="selected"{% endif %}>min</option>
                                        <option value="max"{% if request.terra_project.training.checkpoint.mode.value == 'max' %} selected="selected"{% endif %}>max</option>
                                    </select>
                                </div>
                                <div class="field-form field-inline field-reverse">
                                    <label for="checkpoint[save_best]">Сохранить лучшее</label>
                                    <div class="checkout-switch">
                                        <input type="checkbox" id="checkpoint[save_best]" name="checkpoint[save_best]"{% if request.terra_project.training.checkpoint.save_best %} checked="checked"{% endif %} />
                                        <span class="switcher"></span>
                                    </div>
                                </div>
                                <div class="field-form field-inline field-reverse">
                                    <label for="checkpoint[save_weights]">Сохранить веса</label>
                                    <div class="checkout-switch">
                                        <input type="checkbox" id="checkpoint[save_weights]" name="checkpoint[save_weights]"{% if request.terra_project.training.checkpoint.save_weights %} checked="checked"{% endif %} />
                                        <span class="switcher"></span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="params-item params-callbacks collapsable">
                            <div class="params-title">Выводить</div>
                            {% for layer in request.terra_project.layers.values %}
                                {% if layer.config.location_type == "output" %}
                                    <div class="inner callback-{{ layer.config.dts_layer_name }}">
                                        <div class="title">Слой <b>«{{ layer.config.name }}»</b></div>
                                        <div class="form-inline-label"></div>
                                    </div>
                                {% endif %}
                            {% endfor %}
                        </div>
                    </div>
                </div>

                <div class="params-item params-actions">
                    <div class="inner actions">
                        <div class="actions-form">
                            <div class="item training">
                                <button>{% if request.terra_project.in_training %}Возобновить{% else %}Обучить{% endif %}</button>
                            </div>
                            <div class="item stop">
                                <button disabled="disabled">Остановить</button>
                            </div>
                            <div class="item reset">
                                <button disabled="disabled">Сбросить</button>
                            </div>
<!--                            <div class="item evaluate">-->
<!--                                <button disabled="disabled">Evaluate</button>-->
<!--                            </div>-->
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock content_block %}

{% block modal_window %}
{{ block.super }}
<div id="modal-window-warning" class="modal-window-container">
    <div class="wrapper"></div>
</div>
{% endblock modal_window %}
